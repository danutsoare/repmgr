# PostgreSQL configuration file
# Generated by Ansible for cluster {{ cluster_name }}
# PostgreSQL version {{ postgresql_version }}

#------------------------------------------------------------------------------
# FILE LOCATIONS
#------------------------------------------------------------------------------

data_directory = '{{ postgresql_data_dir }}'
hba_file = '{{ postgresql_config_dir }}/pg_hba.conf'
ident_file = '{{ postgresql_config_dir }}/pg_ident.conf'

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

listen_addresses = '{{ postgresql_listen_addresses }}'
port = {{ postgresql_port }}
max_connections = {{ postgresql_max_connections }}

#------------------------------------------------------------------------------
# RESOURCE USAGE (except WAL)
#------------------------------------------------------------------------------

shared_buffers = {{ (ansible_memtotal_mb * 0.25) | int }}MB
effective_cache_size = {{ (ansible_memtotal_mb * 0.75) | int }}MB
maintenance_work_mem = {{ (ansible_memtotal_mb * 0.05) | int }}MB
work_mem = {{ ((ansible_memtotal_mb * 0.25) / postgresql_max_connections) | int }}MB

#------------------------------------------------------------------------------
# WRITE AHEAD LOG
#------------------------------------------------------------------------------

wal_level = {{ postgresql_wal_level | default('replica') }}
archive_mode = {{ postgresql_archive_mode | default('on') }}
archive_command = '{{ postgresql_archive_command | default("test ! -f /var/lib/pgsql/archive/%f && cp %p /var/lib/pgsql/archive/%f") }}'
max_wal_senders = {{ postgresql_max_wal_senders | default(10) }}
wal_keep_size = 1GB
checkpoint_completion_target = {{ postgresql_checkpoint_completion_target | default(0.9) }}

#------------------------------------------------------------------------------
# REPLICATION
#------------------------------------------------------------------------------

{% if inventory_hostname in groups[cluster_name + '_primary'] %}
# Primary node configuration
hot_standby = off
{% else %}
# Standby node configuration
hot_standby = on
hot_standby_feedback = on
{% endif %}

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------

random_page_cost = 1.1
effective_io_concurrency = 200

#------------------------------------------------------------------------------
# ERROR REPORTING AND LOGGING
#------------------------------------------------------------------------------

log_destination = 'stderr'
logging_collector = on
log_directory = '{{ postgresql_log_dir }}/{{ postgresql_version }}'
log_filename = 'postgresql-{{ cluster_name }}-%Y-%m-%d_%H%M%S.log'
log_truncate_on_rotation = off
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0

#------------------------------------------------------------------------------
# RUNTIME STATISTICS
#------------------------------------------------------------------------------

track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
stats_temp_directory = '/var/run/postgresql/{{ postgresql_version }}-main.pg_stat_tmp'

#------------------------------------------------------------------------------
# AUTOVACUUM PARAMETERS
#------------------------------------------------------------------------------

autovacuum = on
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 1000

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.english'

#------------------------------------------------------------------------------
# repmgr SPECIFIC SETTINGS
#------------------------------------------------------------------------------

shared_preload_libraries = 'repmgr'