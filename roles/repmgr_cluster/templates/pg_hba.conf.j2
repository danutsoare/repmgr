# PostgreSQL Client Authentication Configuration File
# Generated by Ansible for cluster {{ cluster_name }}
# ===================================================
# This file controls: which hosts are allowed to connect, how clients
# are authenticated, which PostgreSQL user names they can use, which
# databases they can access.

# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             all                                     {{ 'trust' if postgresql_hba_trust_local | default(true) else 'peer' }}

# IPv4 local connections:
host    all             all             127.0.0.1/32            {{ 'trust' if postgresql_hba_trust_local | default(true) else 'md5' }}

# IPv6 local connections:
host    all             all             ::1/128                 {{ 'trust' if postgresql_hba_trust_local | default(true) else 'md5' }}

# repmgr connections for cluster nodes
{% for host in groups[cluster_name + '_primary'] + groups[cluster_name + '_standby'] %}
host    {{ repmgr_database }}    {{ repmgr_user }}    {{ hostvars[host]['ansible_default_ipv4']['address'] }}/32    trust
host    replication      {{ repmgr_user }}    {{ hostvars[host]['ansible_default_ipv4']['address'] }}/32    trust
{% endfor %}

# Allow replication connections from standby servers
{% for host in groups[cluster_name + '_standby'] %}
host    replication      {{ repmgr_user }}    {{ hostvars[host]['ansible_default_ipv4']['address'] }}/32    trust
{% endfor %}

# Allow connections from application subnets (customize as needed)
# host    all             all             10.0.0.0/8              md5
# host    all             all             172.16.0.0/12           md5
# host    all             all             192.168.0.0/16          md5