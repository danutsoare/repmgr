# repmgr configuration file
# Generated by Ansible for cluster {{ cluster_name }}

#------------------------------------------------------------------------------
# CLUSTER SETTINGS
#------------------------------------------------------------------------------

cluster={{ repmgr_cluster }}
node_id={{ current_node_id }}
node_name={{ inventory_hostname }}
conninfo='host={{ inventory_hostname }} user={{ repmgr_user }} dbname={{ repmgr_database }} port={{ postgresql_port }} connect_timeout=2'

#------------------------------------------------------------------------------
# DATA DIRECTORY
#------------------------------------------------------------------------------

data_directory='{{ postgresql_data_dir }}'

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------

log_level={{ repmgrd_log_level | default('INFO') }}
log_file='/var/log/repmgr/{{ postgresql_version }}/repmgr-{{ cluster_name }}.log'
log_status_interval=300

#------------------------------------------------------------------------------
# REPLICATION SETTINGS
#------------------------------------------------------------------------------

{% if inventory_hostname in groups[cluster_name + '_primary'] %}
# Primary node configuration
use_replication_slots=yes
{% else %}
# Standby node configuration
upstream_node={{ groups[cluster_name + '_primary'][0] }}
use_replication_slots=yes
{% endif %}

#------------------------------------------------------------------------------
# FAILOVER SETTINGS
#------------------------------------------------------------------------------

failover={{ repmgr_failover | default('automatic') }}
promote_command='{{ repmgr_promote_command }}'
follow_command='{{ repmgr_follow_command }}'

reconnect_attempts={{ repmgr_reconnect_attempts | default(6) }}
reconnect_interval={{ repmgr_reconnect_interval | default(10) }}

#------------------------------------------------------------------------------
# MONITORING
#------------------------------------------------------------------------------

{% if repmgr_monitoring_history | default(true) %}
monitoring_history=yes
monitor_interval_secs={{ repmgr_monitor_interval_secs | default(2) }}
degraded_monitoring_timeout={{ repmgr_degraded_monitoring_timeout | default(300) }}
{% else %}
monitoring_history=no
{% endif %}

#------------------------------------------------------------------------------
# SERVICE COMMANDS
#------------------------------------------------------------------------------

service_start_command='sudo systemctl start {{ postgresql_service_name }}'
service_stop_command='sudo systemctl stop {{ postgresql_service_name }}'
service_restart_command='sudo systemctl restart {{ postgresql_service_name }}'
service_reload_command='sudo systemctl reload {{ postgresql_service_name }}'

repmgrd_service_start_command='sudo systemctl start repmgrd-{{ postgresql_version }}'
repmgrd_service_stop_command='sudo systemctl stop repmgrd-{{ postgresql_version }}'

#------------------------------------------------------------------------------
# DIRECTORIES
#------------------------------------------------------------------------------

pg_bindir='/usr/pgsql-{{ postgresql_version }}/bin'
repmgr_bindir='/usr/pgsql-{{ postgresql_version }}/bin'

#------------------------------------------------------------------------------
# SSH SETTINGS
#------------------------------------------------------------------------------

ssh_options='-q -o ConnectTimeout=10'